import dataset_loader
import tqdm

import numpy as np
import pandas as pd
import tensorflow.keras as keras

labels = ['ID','CWE-119','CWE-120','CWE-476','CWE-468','CWE-other']

def predictions(modele, X_test, ids_test):
    data = {}
    for label in labels:
        data[label] = []
    
    #X_test = X_test[:, :, np.newaxis]
    for t, idt in tqdm.tqdm(zip(X_test, ids_test)):
        data['ID'].append(idt)
        output = modele.predict([t])
        for i in range(5):
            data[labels[i+1]].append(round(output[0][i]))
    return data

def write_csv(filepath, data):
    df = pd.DataFrame(data)
    df.to_csv(filepath, index=False)

def main():
    train, test = dataset_loader.read_csv('participants_dataset.csv')
    X_train, X_test, y_train, ids_test = dataset_loader.create_dataset_and_tokenizer(train, test)

    X_test = np.asarray(X_train).astype(np.float32)

    modele = keras.models.load_model('modele_15.h5')
    modele.summary()
    
    data = predictions(modele, X_test, ids_test)
    write_csv('soumission_2.csv', data)

if __name__ == '__main__':
    main()
